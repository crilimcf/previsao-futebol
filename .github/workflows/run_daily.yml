name: ‚öΩ Daily Football Predictions

on:
  schedule:
    - cron: '30 0 * * *'  # todos os dias √†s 00:30 UTC
  workflow_dispatch:

permissions:
  contents: write     # permite commit/push autom√°tico

jobs:
  run-daily:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚öôÔ∏è Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Check backend health
        id: health
        run: |
          echo "ü©∫ Checking backend health endpoint..."
          STATUS=$(curl -s https://previsao-futebol.onrender.com/healthz || echo "fail")
          echo "Healthz response: $STATUS"
          if echo "$STATUS" | grep -q '"status": "ok"'; then
            echo "‚úÖ Backend saud√°vel, prosseguindo..."
          else
            echo "‚ùå Backend n√£o est√° saud√°vel."
            exit 1
          fi

      - name: üöÄ Run daily update (pull games + train + predict)
        if: ${{ success() && steps.health.conclusion == 'success' }}
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
          API_FOOTBALL_BASE: ${{ secrets.API_FOOTBALL_BASE }}
          API_FOOTBALL_SEASON: ${{ secrets.API_FOOTBALL_SEASON }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          UPSTASH_REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL }}
          UPSTASH_REDIS_TOKEN: ${{ secrets.UPSTASH_REDIS_TOKEN }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          echo "Running daily prediction update..."
          python run_daily.py

      - name: üíæ Commit & push predictions if changed
        if: ${{ success() && steps.health.conclusion == 'success' }}
        run: |
          echo "Checking for prediction updates..."
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A data/predictions.json results/*.json || true
          if git diff --cached --quiet; then
            echo "üü¢ Nenhuma altera√ß√£o em predictions."
          else
            git commit -m "chore: update daily football predictions ($(date -u +'%Y-%m-%d'))"
            git push
            echo "‚úÖ Predictions committed & pushed."
          fi

      - name: üö® Send Telegram alert if backend down
        if: failure()
        run: |
          echo "Backend offline ‚Äî enviando alerta Telegram..."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚ö†Ô∏è O backend est√° offline! O cron n√£o foi executado. (healthz falhou)"
