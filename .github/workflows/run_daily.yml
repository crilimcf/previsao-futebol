name: ‚öΩ Daily Football Predictions

on:
  schedule:
    - cron: '30 0 * * *'  # todos os dias √†s 06h00 UTC
  workflow_dispatch:      # tamb√©m pode ser executado manualmente

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚öôÔ∏è Install dependencies
        run: |
          pip install -r requirements.txt

      - name: üîç Check backend health
        id: health
        run: |
          echo "ü©∫ Checking backend health endpoint..."
          STATUS=$(curl -s https://previsao-futebol.onrender.com/healthz || echo "fail")
          echo "Healthz response: $STATUS"

          if echo "$STATUS" | grep -q '"status": "ok"'; then
            echo "‚úÖ Backend saud√°vel, prosseguindo..."
            echo "ok" > health.txt
          else
            echo "‚ùå Backend n√£o est√° saud√°vel."
            echo "fail" > health.txt
          fi

      - name: üöÄ Run daily update
        if: ${{ hashFiles('health.txt') == 'ok' }}
        run: |
          echo "Running daily prediction update..."
          python run_daily.py

      - name: üö® Send Telegram alert if backend down
        if: ${{ hashFiles('health.txt') != 'ok' }}
        run: |
          echo "Backend offline ‚Äî enviando alerta Telegram..."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚ö†Ô∏è O backend est√° offline! O cron n√£o foi executado. (healthz falhou)"
