name: Train bivariate correlation (weekly)

on:
  schedule:
    - cron: "10 0 * * 1"   # segundas 00:10 UTC
  workflow_dispatch:
    inputs:
      seasons:
        description: "Épocas (comma-separated), ex: 2022,2023,2024"
        required: false
        default: "2024"

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    env:
      API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
      API_FOOTBALL_BASE: ${{ vars.API_FOOTBALL_BASE || 'https://v3.football.api-sports.io/' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compute seasons
        run: |
          set -euxo pipefail
          S="${{ github.event.inputs.seasons }}"
          if [ -z "$S" ]; then
            if [ -n "${{ vars.SEASONS }}" ]; then S="${{ vars.SEASONS }}";
            elif [ -n "${{ vars.SEASON }}" ]; then S="${{ vars.SEASON }}";
            elif [ -n "${{ secrets.API_FOOTBALL_SEASONS }}" ]; then S="${{ secrets.API_FOOTBALL_SEASONS }}";
            elif [ -n "${{ secrets.API_FOOTBALL_SEASON }}" ]; then S="${{ secrets.API_FOOTBALL_SEASON }}";
            else S="2024"; fi
          fi
          A=""
          IFS=',' read -ra arr <<< "$S"
          for e in "${arr[@]}"; do
            e="$(echo "$e" | xargs)"
            [ -n "$e" ] && A="$A --season $e"
          done
          echo "SEASONS=$S"     >> "$GITHUB_ENV"
          echo "SEASON_ARGS=$A" >> "$GITHUB_ENV"
          echo "Using seasons: $S"
          echo "Args: $A"

      - name: Ensure curated leagues (fallback if missing)
        run: |
          set -euxo pipefail
          mkdir -p config
          if [ ! -s config/leagues_main.json ]; then
            printf '%s\n' \
            '{ "leagues": [' \
            '{"id":39,"name":"Premier League"},' \
            '{"id":140,"name":"La Liga"},' \
            '{"id":135,"name":"Serie A"},' \
            '{"id":78,"name":"Bundesliga"},' \
            '{"id":61,"name":"Ligue 1"},' \
            '{"id":94,"name":"Primeira Liga"},' \
            '{"id":45,"name":"Eredivisie"},' \
            '{"id":88,"name":"Super Lig"},' \
            '{"id":203,"name":"Brasileirao"},' \
            '{"id":253,"name":"MLS"}' \
            ']}' > config/leagues_main.json
          fi

      - name: Export CSV for λ3
        run: |
          set -euxo pipefail
          mkdir -p data/train
          # aceita múltiplos --season (ex.: --season 2024 --season 2025)
          python scripts/export_poisson_inputs_from_api.py $SEASON_ARGS || true
          if [ ! -s data/train/poisson_inputs.csv ]; then
            echo "Sem dados exportados; a treinar será ignorado."
            echo "SKIP_L3=1" >> "$GITHUB_ENV"
          fi

      - name: Train λ3 per league
        if: env.SKIP_L3 != '1'
        run: |
          set -euxo pipefail
          python scripts/train_lambda3_per_league.py

      - name: Commit λ3 (rebase)
        if: env.SKIP_L3 != '1'
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add models/bivar_lambda3.json
          if git diff --cached --quiet; then
            echo "Sem alterações."
          else
            git fetch origin
            git rebase origin/main || true
            git commit -m "chore(models): refresh λ3 por liga"
            git push origin HEAD:main
          fi
