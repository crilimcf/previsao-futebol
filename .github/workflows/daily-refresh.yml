name: Daily refresh (update + calibrate)

on:
  schedule:
    # Corre todos os dias Ã s 03:15 UTC (em Lisboa normalmente = 03:15 no inverno; no verÃ£o Ã© 04:15 local).
    - cron: "15 3 * * *"
  workflow_dispatch: {}   # permite correr manualmente no GitHub

concurrency:
  group: daily-refresh
  cancel-in-progress: false

jobs:
  hit-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      BACKEND_BASE: ${{ secrets.BACKEND_BASE }}          # ex: https://previsao-futebol.onrender.com
      BACKEND_TOKEN: ${{ secrets.BACKEND_BEARER }}       # o teu Bearer
      VERCEL_WARM_URL: ${{ secrets.VERCEL_WARM_URL }}    # opcional: URL pÃºblica do teu site para â€œaquecerâ€ a cache
    steps:
      - name: Show time
        run: date -u

      - name: Update predictions
        run: |
          set -e
          curl -fsS -X POST "$BACKEND_BASE/meta/update" \
            -H "Authorization: Bearer $BACKEND_TOKEN"
          echo "âœ… /meta/update OK"

      - name: Calibrate (safe to skip if not present)
        run: |
          set +e
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "$BACKEND_BASE/meta/calibrate" \
            -H "Authorization: Bearer $BACKEND_TOKEN")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… /meta/calibrate OK"
          else
            echo "â„¹ï¸ /meta/calibrate nÃ£o disponÃ­vel (HTTP $HTTP_CODE) â€” a ignorar."
          fi

      - name: Health check
        run: |
          curl -fsS "$BACKEND_BASE/healthz"
          curl -fsS "$BACKEND_BASE/meta/last-update"
          echo "âœ… backend saudÃ¡vel"

      - name: Warm frontend (optional)
        if: env.VERCEL_WARM_URL != ''
        run: |
          # puxa pÃ¡gina principal e com datas tÃ­picas para preparar caches do Next
          curl -fsS "$VERCEL_WARM_URL" >/dev/null
          TODAY=$(date -u +"%Y-%m-%d")
          curl -fsS "$VERCEL_WARM_URL?date=$TODAY" >/dev/null
          echo "ğŸ”¥ frontend aquecido"
